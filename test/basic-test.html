<!doctype html>
<!--
@license
Copyright (c) 2015 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../../web-component-tester/browser.js"></script>
    <script src="../../iron-test-helpers/test-helpers.js"></script>
    <script src="../../iron-test-helpers/mock-interactions.js"></script>
    <link rel="import" href="../multipart-payload-editor.html">
  </head>
  <body>

    <test-fixture id="basic">
      <template>
        <multipart-payload-editor></multipart-payload-editor>
      </template>
    </test-fixture>

    <test-fixture id="opened">
      <template>
        <multipart-payload-editor attr-for-opened="opened"></multipart-payload-editor>
      </template>
    </test-fixture>

    <script>
    /* global fixture, assert, TestHelpers, sinon */
    suite('multipart-payload-editor', function() {
      suite('basic', function() {
        var element;

        setup(function() {
          element = fixture('basic');
          TestHelpers.forceXIfStamp(element);
        });

        test('model is an array', function() {
          assert.typeOf(element.model, 'array');
        });

        test('model has one item', function() {
          assert.lengthOf(element.model, 1);
        });

        test('added item is a file', function() {
          assert.isTrue(element.model[0].isFile);
        });

        test('value is undefined', function() {
          assert.isUndefined(element.value);
        });

        test('value is messagePreview', function() {
          assert.isUndefined(element.messagePreview);
        });

        test('previewOpened is false', function() {
          assert.isFalse(element.previewOpened);
        });

        test('generatingPreview is undefined', function() {
          assert.isUndefined(element.generatingPreview);
        });
      });

      suite('addFile()', function() {
        var element;

        setup(function() {
          element = fixture('basic');
          element.addFile();
        });

        test('model is an array', function() {
          assert.typeOf(element.model, 'array');
        });

        test('model has two item', function() {
          assert.lengthOf(element.model, 2);
        });

        test('added item is a file', function() {
          assert.isTrue(element.model[1].isFile);
        });

        test('added item has empty name', function() {
          assert.equal(element.model[1].name, '');
        });

        test('added item value is undefined', function() {
          assert.notOk(element.model[1].value);
        });
      });

      suite('addText()', function() {
        var element;

        setup(function() {
          element = fixture('basic');
          element.addText();
        });

        function hasAdvancedSupport() {
          return element.hasFormDataSupport;
        }

        test('model is an array', function() {
          assert.typeOf(element.model, 'array');
        });

        test('model has one item', function() {
          assert.lengthOf(element.model, 2);
        });

        test('added item is not a file', function() {
          assert.isFalse(element.model[1].isFile);
        });

        test('added item has empty name', function() {
          assert.equal(element.model[1].name, '');
        });

        test('added item has empty value', function() {
          assert.equal(element.model[1].value, '');
        });

        test('added item has empty contentType', TestHelpers.skipUnless(hasAdvancedSupport, function() {
          assert.equal(element.model[1].contentType, '');
        }));
      });

      suite('createFormData()', function() {
        var element;

        setup(function() {
          element = fixture('basic');
        });

        test('Do not generate FormData with empty model', function() {
          assert.isUndefined(element.createFormData([]));
        });

        test('Do not generate FormData data for model with empty values', function() {
          assert.isUndefined(element.createFormData([{name: '', file: true}]));
        });

        test('Generates form data for text value', function() {
          var fd = element.createFormData([{name: 'test', value: 'test', text: true}]);
          assert.typeOf(fd, 'formdata');
        });

        test('Generates form data for text value with content type', function() {
          var fd = element.createFormData([{
            name: 'test',
            value: 'test',
            isFile: false,
            contentType: 'application/json'
          }]);
          assert.typeOf(fd, 'formdata');
        });

        test('Generates form data for file value', function() {
          var fd = element.createFormData([{
            name: 'test',
            value: new Blob(['test'], {type: 'application/json'}),
            isFile: true
          }]);
          assert.typeOf(fd, 'formdata');
        });
      });

      suite('action controls', function() {
        var element;

        setup(function() {
          element = fixture('basic');
          TestHelpers.forceXIfStamp(element);
        });

        function hasAdvancedSupport() {
          return element.hasFormDataSupport;
        }

        function advancedSupportDisabled() {
          return !element.hasFormDataSupport;
        }

        test('editor-actions are rendered', TestHelpers.skipUnless(hasAdvancedSupport, function() {
          var container = element.$$('.editor-actions');
          assert.ok(container);
        }));

        test('editor-actions are rendered', TestHelpers.skipUnless(advancedSupportDisabled, function() {
          var container = element.$$('.editor-actions');
          assert.notOk(container);
        }));

      });

      suite('_generatePreview()', function() {
        var element;

        setup(function() {
          element = fixture('basic');
        });

        function hasAdvancedSupport() {
          return element.hasFormDataSupport;
        }

        test('Generates preview data for file', TestHelpers.skipUnless(hasAdvancedSupport, function() {
          var fd = element.createFormData([{
            name: 'test',
            value: 'test',
            text: true,
            contentType: 'application/json'
          }]);
          element.value = fd;
          return element._generatePreview()
          .then(function(content) {
            assert.typeOf(content, 'strnig');
          });
        }));

        test('Generates preview data for text', TestHelpers.skipUnless(hasAdvancedSupport, function() {
          var fd = element.createFormData([{name: 'test', value: 'test', text: true}]);
          element.value = fd;
          return element._generatePreview()
          .then(function(content) {
            assert.typeOf(content, 'strnig');
          });
        }));

        test('messagePreview is cleared', TestHelpers.skipUnless(hasAdvancedSupport, function() {
          var fd = element.createFormData([{name: 'test', value: 'test', text: true}]);
          element.value = fd;
          element._generatePreview();
          assert.isUndefined(element.messagePreview);
        }));

        test('messagePreview is set after finish',
          TestHelpers.skipUnless(hasAdvancedSupport, function() {
          var fd = element.createFormData([{name: 'test', value: 'test', text: true}]);
          element.value = fd;
          return element._generatePreview()
          .then(function() {
            assert.typeOf(element.messagePreview, 'strnig');
          });
        }));

        test('generatingPreview is true when working',
          TestHelpers.skipUnless(hasAdvancedSupport, function() {
          var fd = element.createFormData([{name: 'test', value: 'test', text: true}]);
          element.value = fd;
          element._generatePreview();
          assert.isTrue(element.generatingPreview);
        }));

        test('generatingPreview is false after finish',
          TestHelpers.skipUnless(hasAdvancedSupport, function() {
          var fd = element.createFormData([{name: 'test', value: 'test', text: true}]);
          element.value = fd;
          return element._generatePreview()
          .then(function() {
            assert.isFalse(element.generatingPreview);
          });
        }));
      });

      suite('model change notifier', function() {
        var element;

        setup(function() {
          element = fixture('basic');
        });

        test('Sets a value', function() {
          element.set(['model', 0, 'name'], 'test');
          element.set(['model', 0, 'value'], 'test');
          assert.typeOf(element.value, 'formdata');
        });

        test('Fires payload-value-changed event', function() {
          var spy = sinon.stub();
          element.addEventListener('payload-value-changed', spy);

          element.set(['model', 0, 'name'], 'test');
          element.set(['model', 0, 'value'], 'test');
          assert.isTrue(spy.called);
        });
      });

      suite('attr-for-opened', function() {
        var element;

        setup(function() {
          element = fixture('opened');
          TestHelpers.forceXIfStamp(element);
        });

        test('Do not modifies the value if not opened', function() {
          var compare = element.value;
          element.set(['model', 0, 'name'], 'test');
          element.set(['model', 0, 'value'], 'test');
          assert.equal(element.value, compare);
        });

        test('Modifies the value when opened', function() {
          var compare = element.value;
          element.setAttribute('opened', true);
          element.set(['model', 0, 'name'], 'test');
          element.set(['model', 0, 'value'], 'test');
          assert.notEqual(element.value, compare);
        });

        test('Do not fires payload-value-changed event', function() {
          var spy = sinon.stub();
          element.addEventListener('payload-value-changed', spy);

          element.set(['model', 0, 'name'], 'test');
          element.set(['model', 0, 'value'], 'test');
          assert.isFalse(spy.called);
        });

        test('Fires payload-value-changed event when opened', function() {
          var spy = sinon.stub();
          element.addEventListener('payload-value-changed', spy);
          element.setAttribute('opened', true);
          element.set(['model', 0, 'name'], 'test');
          element.set(['model', 0, 'value'], 'test');
          assert.isTrue(spy.called);
        });
      });
    });

    suite('Restore form data', function() {
      var fd;
      var element;
      setup(function() {
        fd = new FormData();
        fd.append('text', 'test');
        fd.append('file', new Blob(['test', {type: 'plain/text'}]));
        element = fixture('basic');
      });

      test('Creates model from FormData', function() {
        element.value = fd;
        assert.typeOf(element.model, 'array');
        assert.lengthOf(element.model, 2);
      });

      test('Restores text data', function() {
        element.value = fd;
        var model = element.model[0];
        assert.isFalse(model.isFile);
        assert.equal(model.name, 'text');
        assert.equal(model.value, 'test');
      });

      test('Restores file data', function() {
        element.value = fd;
        var model = element.model[1];
        assert.isTrue(model.isFile);
        assert.equal(model.name, 'file');
        assert.isTrue(model.value instanceof Blob);
      });
    });
    </script>

  </body>
</html>
